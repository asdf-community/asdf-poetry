#!/usr/bin/env bash

set -Eeuo pipefail

trap cleanup SIGINT SIGTERM ERR

cleanup() {
  trap - SIGINT SIGTERM ERR
  rm -rf "$ASDF_INSTALL_PATH"
  echo
  echo "Cleanup: Something went wrong!"
  echo
  echo "$(caller): ${BASH_COMMAND}"
}

semver_ge() {
  printf '%s\n%s\n' "$2" "$1" | sort --check=quiet --version-sort
}

install_poetry() {
  local install_type=$1
  local version=$2
  local install_path=$3
  local flags=

  if [ "$install_type" == "version" ]; then
    semver_ge "$ASDF_INSTALL_VERSION" 1.1.7 && install_vercomp="ge" || install_vercomp="lt"
    semver_ge "$ASDF_INSTALL_VERSION" 1.2.0 && config_vercomp="ge" || config_vercomp="lt"
    semver_ge "$ASDF_INSTALL_VERSION" 2.0.0 && venv_vercomp="ge" || venv_vercomp="lt"
  else
    install_vercomp="ge"
    config_vercomp="lt"
    venv_vercomp="lt"
  fi

  if [[ -n ${ASDF_POETRY_INSTALL_URL-} ]]; then
    install_url=$ASDF_POETRY_INSTALL_URL
  elif [ "$install_vercomp" == "ge" ]; then
    install_url="https://install.python-poetry.org"
  else
    # last committed get-poetry.py
    install_url="https://raw.githubusercontent.com/python-poetry/poetry/d222411ae9d01a04ec8eda348a65aa83852c37d0/get-poetry.py"
  fi

  if [[ $install_url == *get-poetry* ]]; then
    flags=--no-modify-path
  fi

  if [ "$install_type" = "version" ]; then
    curl -sSL "$install_url" | POETRY_HOME=$install_path python3 - --version "$version" $flags
  elif [ "$install_type" = "ref" ]; then
    curl -sSL "$install_url" | POETRY_HOME=$install_path python3 - --git https://github.com/python-poetry/poetry.git@"$version" $flags
  else
    fail "unknown install type"
  fi

  if [ "$config_vercomp" == "ge" ]; then
    # Ensure that poetry behaves as expected with asdf python (pyenv)
    echo Configuring poetry to behave properly with asdf ...
    if [ "$venv_vercomp" == "ge" ]; then
      echo Running: \"poetry config virtualenvs.use-poetry-python false\".
      echo ""
      "$install_path"/bin/poetry config virtualenvs.use-poetry-python false
    else
      echo Running: \"poetry config virtualenvs.prefer-active-python true\".
      echo ""
      "$install_path"/bin/poetry config virtualenvs.prefer-active-python true
    fi
  else
    echo Warning: Poetry versions prior to 1.2.0 may not work properly with asdf.
    echo Consider upgrading to a later version.
    echo https://github.com/asdf-community/asdf-poetry/issues/10
  fi

  if [ $config_vercomp == "ge" ]; then
    if echo "$SHELL" | grep -q "bash"; then
      if [ ! -f "$HOME/.bash_completion" ]; then
        echo "Detected default shell Bash"
        echo "Setting up autocompletion for Bash..."
        "$install_path"/bin/poetry completions bash >~/.bash_completion
      elif grep -q '_poetry_' ~/.bash_completion; then
        echo "Detected default shell Bash"
        echo "Setting up autocompletion for Bash..."
        "$install_path"/bin/poetry completions bash >~/.bash_completion
      fi
    elif echo "$SHELL" | grep -q "zsh"; then
      if [ ! -d "$HOME/.zfunc/" ]; then
        mkdir -p ~/.zfunc
      fi
      if [ ! -f "$HOME/.zfunc/_poetry" ]; then
        echo "Detected default shell Zsh"
        echo "Setting up autocompletion for Zsh..."
        "$install_path"/bin/poetry completions zsh >~/.zfunc/_poetry
      fi
      grep -qxF 'fpath+=~/.zfunc' ~/.zshrc || echo "fpath+=~/.zfunc" >>~/.zshrc
      grep -qxF 'autoload -Uz compinit && compinit' ~/.zshrc || echo "autoload -Uz compinit && compinit" >>~/.zshrc
    elif echo "$SHELL" | grep -q "fish"; then
      if [ ! -f "$HOME/.config/fish/completions/poetry.fish" ]; then
        echo "Detected default shell fish"
        echo "Setting up autocompletion for fish..."
        "$install_path"/bin/poetry completions fish >~/.config/fish/completions/poetry.fish
      fi
    else
      echo "Warning: Could not detect shells Bash, Zsh or fish."
      echo "Could not complete autocompletion setup"
    fi
  else
    echo "Warning: Poetry versions prior to 1.2.0 do not have autocompletion"
  fi
}

install_poetry "$ASDF_INSTALL_TYPE" "$ASDF_INSTALL_VERSION" "$ASDF_INSTALL_PATH"
